# Tắt directory listing để ngăn chặn Directory Listing Vulnerability
Options -Indexes

# Bảo mật chống lại Path Disclosure
ServerTokens Prod
ServerSignature Off

# URL Rewrite Engine - Bật chế độ rewrite
RewriteEngine On

# Chặn truy cập trực tiếp vào các thư mục nhạy cảm
RewriteRule ^backup-php-project/ - [F,L]
RewriteRule ^security/(?!demo/security-demo\.html$) - [F,L]
RewriteRule ^assets/(?!.*\.(css|js|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$) - [F,L]
RewriteRule ^api/(?!.*\.(json|xml)$) - [F,L]
RewriteRule ^models/ - [F,L]
RewriteRule ^middleware/ - [F,L]

# Chặn truy cập vào các file cấu hình và nhạy cảm
RewriteRule ^\.(htaccess|htpasswd|env|gitignore|nojekyll)$ - [F,L]
RewriteRule \.(log|sql|bak|backup|old|tmp|db|sqlite)$ - [F,L]
RewriteRule ^(package\.json|package-lock\.json|server\.js|test-server\.js)$ - [F,L]

# Redirect 301 từ .html về URL không có extension (chuẩn SEO)
RewriteCond %{THE_REQUEST} \s/+([^.\s?]*)\.html[\s?] [NC]
RewriteRule ^ /%1? [R=301,L]

# Xử lý trailing slash - redirect về URL không có slash cuối
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} (.+)/$
RewriteRule ^ %1 [R=301,L]

# URL Rewrite cho các trang HTML - tự động load file .html khi truy cập /abc
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME}\.html -f
RewriteRule ^([^./]+)/?$ $1.html [L]

# Xử lý trang chủ - load index.html khi truy cập /
RewriteCond %{REQUEST_URI} ^/?$
RewriteRule ^$ index.html [L]

# Bảo mật headers
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# Content Security Policy - Tối ưu cho Tailwind CSS và các CDN
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com https://cdn.tailwindcss.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self';"

# HSTS (HTTP Strict Transport Security)
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

# Chặn các phương thức HTTP không cần thiết
RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK|OPTIONS|HEAD) [NC]
RewriteRule .* - [F,L]

# Chặn User-Agent độc hại
RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (;|<|>|'|"|\)|(|%0A|%0D|%22|%27|%28|%3C|%3E|%00).*(libwww-perl|wget|python|nikto|curl|scan|java|winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner) [NC]
RewriteRule .* - [F,L]

# Chặn SQL Injection attempts trong URL
RewriteCond %{QUERY_STRING} (union.*select|insert.*into|delete.*from|drop.*table) [NC,OR]
RewriteCond %{QUERY_STRING} (script.*:|javascript:|vbscript:|onload|onerror) [NC,OR]
RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (\.\./) [NC,OR]
RewriteCond %{QUERY_STRING} (etc/passwd|boot\.ini) [NC]
RewriteRule .* - [F,L]

# Chặn Path Traversal attacks
RewriteCond %{REQUEST_URI} (\.\./) [NC,OR]
RewriteCond %{REQUEST_URI} (etc/passwd|boot\.ini|windows/system32) [NC]
RewriteRule .* - [F,L]

# Chặn truy cập vào các file backup và log
RewriteRule \.(bak|backup|old|orig|save|swo|swp|tmp|log)$ - [F,L]

# Giới hạn kích thước file upload (nếu có)
LimitRequestBody 10485760

# Timeout settings
Timeout 300

# Chặn hotlinking (tùy chọn)
# RewriteCond %{HTTP_REFERER} !^$
# RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain\.com [NC]
# RewriteRule \.(jpg|jpeg|png|gif|css|js)$ - [F,L]

# Error pages tùy chỉnh
ErrorDocument 403 /403.html
ErrorDocument 404 /404.html
ErrorDocument 500 /500.html