<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Đăng ký - Serein Blog</title>
    
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- icheck bootstrap -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/icheck-bootstrap/3.0.1/icheck-bootstrap.min.css">
    <!-- AdminLTE -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">
    
    <style>
        .register-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .register-box {
            width: 400px;
            margin: 5% auto;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: none;
        }
        .card-body {
            padding: 2rem;
        }
        .register-logo a {
            color: #fff;
            font-size: 2.1rem;
            font-weight: 300;
            text-decoration: none;
        }
        .register-box-msg {
            margin: 0 0 20px 0;
            text-align: center;
            color: #666;
            font-weight: 400;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            font-weight: 500;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .form-control {
            border-radius: 25px;
            border: 1px solid #ddd;
            padding: 12px 20px;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .input-group-text {
            border-radius: 0 25px 25px 0;
            border-left: none;
            background: #f8f9fa;
        }
        .input-group .form-control {
            border-radius: 25px 0 0 25px;
            border-right: none;
        }
        .alert {
            border-radius: 10px;
            border: none;
        }
        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .language-selector .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 20px;
        }
        .language-selector .dropdown-menu {
            border-radius: 10px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .password-strength {
            margin-top: 5px;
            font-size: 0.8rem;
        }
        .strength-weak { color: #dc3545; }
        .strength-medium { color: #ffc107; }
        .strength-strong { color: #28a745; }
        .terms-checkbox {
            margin: 15px 0;
        }
        .social-auth {
            margin-top: 20px;
            text-align: center;
        }
        .social-auth .btn {
            margin: 5px;
            border-radius: 25px;
            padding: 10px 20px;
        }
        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }
        .divider:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }
        .divider span {
            background: white;
            padding: 0 15px;
            color: #666;
        }
    </style>
</head>
<body class="hold-transition register-page">
    <!-- Language selector -->
    <div class="language-selector dropdown">
        <button class="btn btn-sm dropdown-toggle" type="button" id="languageDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-globe"></i> VI
        </button>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="languageDropdown">
            <a class="dropdown-item" href="#" onclick="changeLanguage('vi')">
                <i class="fas fa-flag"></i> Tiếng Việt
            </a>
            <a class="dropdown-item" href="#" onclick="changeLanguage('en')">
                <i class="fas fa-flag"></i> English
            </a>
        </div>
    </div>

    <div class="register-box">
        <div class="register-logo">
            <a href="/"><b>Serein</b>Blog</a>
        </div>
        
        <div class="card">
            <div class="card-body register-card-body">
                <p class="register-box-msg">Đăng ký tài khoản mới</p>
                
                <!-- Error Alert -->
                <div id="error-alert" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="error-message"></span>
                </div>
                
                <!-- Success Alert -->
                <div id="success-alert" class="alert alert-success" style="display: none;">
                    <i class="fas fa-check-circle"></i>
                    <span id="success-message"></span>
                </div>
                
                <form id="registerForm">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="fullname" name="fullname" placeholder="Họ và tên" required>
                        <div class="input-group-append">
                            <div class="input-group-text">
                                <span class="fas fa-user"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="username" name="username" placeholder="Tên đăng nhập" required>
                        <div class="input-group-append">
                            <div class="input-group-text">
                                <span class="fas fa-user-circle"></span>
                            </div>
                        </div>
                        <div class="invalid-feedback" id="username-feedback"></div>
                    </div>
                    
                    <div class="input-group mb-3">
                        <input type="email" class="form-control" id="email" name="email" placeholder="Email" required>
                        <div class="input-group-append">
                            <div class="input-group-text">
                                <span class="fas fa-envelope"></span>
                            </div>
                        </div>
                        <div class="invalid-feedback" id="email-feedback"></div>
                    </div>
                    
                    <div class="input-group mb-3">
                        <input type="password" class="form-control" id="password" name="password" placeholder="Mật khẩu" required>
                        <div class="input-group-append">
                            <div class="input-group-text">
                                <span class="fas fa-lock"></span>
                            </div>
                        </div>
                    </div>
                    <div class="password-strength" id="password-strength"></div>
                    
                    <div class="input-group mb-3">
                        <input type="password" class="form-control" id="password_confirm" name="password_confirm" placeholder="Xác nhận mật khẩu" required>
                        <div class="input-group-append">
                            <div class="input-group-text">
                                <span class="fas fa-lock"></span>
                            </div>
                        </div>
                        <div class="invalid-feedback" id="password-confirm-feedback"></div>
                    </div>
                    
                    <div class="terms-checkbox">
                        <div class="icheck-primary">
                            <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
                            <label for="agreeTerms">
                                Tôi đồng ý với <a href="/terms" target="_blank">Điều khoản sử dụng</a> và <a href="/privacy" target="_blank">Chính sách bảo mật</a>
                            </label>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary btn-block" id="registerBtn">
                                <span id="registerBtnText">Đăng ký</span>
                                <i id="registerSpinner" class="fas fa-spinner fa-spin" style="display: none;"></i>
                            </button>
                        </div>
                    </div>
                </form>
                
                <div class="divider">
                    <span>hoặc</span>
                </div>
                
                <div class="social-auth">
                    <button type="button" class="btn btn-danger btn-sm" onclick="registerWithGoogle()">
                        <i class="fab fa-google"></i> Google
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="registerWithFacebook()">
                        <i class="fab fa-facebook-f"></i> Facebook
                    </button>
                </div>
                
                <p class="mb-0 text-center mt-3">
                    <a href="/login" class="text-center">Đã có tài khoản? Đăng nhập ngay</a>
                </p>
                <p class="mb-0 text-center mt-2">
                    <a href="/" class="text-muted">← Quay về trang chủ</a>
                </p>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
    
    <script>
        // Language translations
        const translations = {
            vi: {
                title: 'Đăng ký - Serein Blog',
                registerMessage: 'Đăng ký tài khoản mới',
                fullname: 'Họ và tên',
                username: 'Tên đăng nhập',
                email: 'Email',
                password: 'Mật khẩu',
                passwordConfirm: 'Xác nhận mật khẩu',
                register: 'Đăng ký',
                agreeTerms: 'Tôi đồng ý với Điều khoản sử dụng và Chính sách bảo mật',
                haveAccount: 'Đã có tài khoản? Đăng nhập ngay',
                backHome: '← Quay về trang chủ',
                registerSuccess: 'Đăng ký thành công! Vui lòng kiểm tra email để xác thực tài khoản.',
                registerError: 'Có lỗi xảy ra trong quá trình đăng ký',
                networkError: 'Lỗi kết nối mạng. Vui lòng thử lại.',
                requiredFields: 'Vui lòng điền đầy đủ thông tin',
                passwordMismatch: 'Mật khẩu xác nhận không khớp',
                weakPassword: 'Mật khẩu yếu',
                mediumPassword: 'Mật khẩu trung bình',
                strongPassword: 'Mật khẩu mạnh',
                usernameExists: 'Tên đăng nhập đã tồn tại',
                emailExists: 'Email đã được sử dụng',
                invalidEmail: 'Email không hợp lệ',
                agreeTermsRequired: 'Vui lòng đồng ý với điều khoản sử dụng'
            },
            en: {
                title: 'Register - Serein Blog',
                registerMessage: 'Register a new account',
                fullname: 'Full Name',
                username: 'Username',
                email: 'Email',
                password: 'Password',
                passwordConfirm: 'Confirm Password',
                register: 'Register',
                agreeTerms: 'I agree to the Terms of Service and Privacy Policy',
                haveAccount: 'Already have an account? Sign in',
                backHome: '← Back to Home',
                registerSuccess: 'Registration successful! Please check your email to verify your account.',
                registerError: 'An error occurred during registration',
                networkError: 'Network error. Please try again.',
                requiredFields: 'Please fill in all required fields',
                passwordMismatch: 'Password confirmation does not match',
                weakPassword: 'Weak password',
                mediumPassword: 'Medium password',
                strongPassword: 'Strong password',
                usernameExists: 'Username already exists',
                emailExists: 'Email already in use',
                invalidEmail: 'Invalid email address',
                agreeTermsRequired: 'Please agree to the terms of service'
            }
        };
        
        let currentLang = 'vi';
        
        // Change language function
        function changeLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            
            document.title = t.title;
            document.querySelector('.register-box-msg').textContent = t.registerMessage;
            document.getElementById('fullname').placeholder = t.fullname;
            document.getElementById('username').placeholder = t.username;
            document.getElementById('email').placeholder = t.email;
            document.getElementById('password').placeholder = t.password;
            document.getElementById('password_confirm').placeholder = t.passwordConfirm;
            document.getElementById('registerBtnText').textContent = t.register;
            document.querySelector('a[href="/login"]').textContent = t.haveAccount;
            document.querySelector('a[href="/"]').textContent = t.backHome;
            
            // Update language selector
            document.getElementById('languageDropdown').innerHTML = `<i class="fas fa-globe"></i> ${lang.toUpperCase()}`;
        }
        
        // Show alert function
        function showAlert(type, message) {
            const alertId = type === 'error' ? 'error-alert' : 'success-alert';
            const messageId = type === 'error' ? 'error-message' : 'success-message';
            
            document.getElementById(messageId).textContent = message;
            document.getElementById(alertId).style.display = 'block';
            
            // Hide other alert
            const otherAlertId = type === 'error' ? 'success-alert' : 'error-alert';
            document.getElementById(otherAlertId).style.display = 'none';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                document.getElementById(alertId).style.display = 'none';
            }, 5000);
        }
        
        // Password strength checker
        function checkPasswordStrength(password) {
            const t = translations[currentLang];
            let strength = 0;
            let feedback = '';
            
            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            if (strength < 3) {
                feedback = `<span class="strength-weak">${t.weakPassword}</span>`;
            } else if (strength < 5) {
                feedback = `<span class="strength-medium">${t.mediumPassword}</span>`;
            } else {
                feedback = `<span class="strength-strong">${t.strongPassword}</span>`;
            }
            
            document.getElementById('password-strength').innerHTML = feedback;
            return strength;
        }
        
        // Real-time validation
        document.getElementById('password').addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });
        
        document.getElementById('password_confirm').addEventListener('input', function() {
            const password = document.getElementById('password').value;
            const confirmPassword = this.value;
            const feedback = document.getElementById('password-confirm-feedback');
            
            if (confirmPassword && password !== confirmPassword) {
                this.classList.add('is-invalid');
                feedback.textContent = translations[currentLang].passwordMismatch;
                feedback.style.display = 'block';
            } else {
                this.classList.remove('is-invalid');
                feedback.style.display = 'none';
            }
        });
        
        // Username availability check
        let usernameTimeout;
        document.getElementById('username').addEventListener('input', function() {
            const username = this.value.trim();
            const feedback = document.getElementById('username-feedback');
            
            if (username.length < 3) {
                this.classList.remove('is-valid', 'is-invalid');
                feedback.style.display = 'none';
                return;
            }
            
            clearTimeout(usernameTimeout);
            usernameTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/auth/check-username/${encodeURIComponent(username)}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.available) {
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                        feedback.style.display = 'none';
                    } else {
                        this.classList.remove('is-valid');
                        this.classList.add('is-invalid');
                        feedback.textContent = translations[currentLang].usernameExists;
                        feedback.style.display = 'block';
                    }
                } catch (error) {
                    console.log('Username check failed:', error);
                }
            }, 500);
        });
        
        // Email validation
        document.getElementById('email').addEventListener('blur', async function() {
            const email = this.value.trim();
            const feedback = document.getElementById('email-feedback');
            
            if (!email) return;
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                this.classList.add('is-invalid');
                feedback.textContent = translations[currentLang].invalidEmail;
                feedback.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`/api/auth/check-email/${encodeURIComponent(email)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.available) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    feedback.style.display = 'none';
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                    feedback.textContent = translations[currentLang].emailExists;
                    feedback.style.display = 'block';
                }
            } catch (error) {
                console.log('Email check failed:', error);
            }
        });
        
        // Get CSRF token
        async function getCSRFToken() {
            try {
                const response = await fetch('/api/csrf-token');
                const data = await response.json();
                return data.csrf_token;
            } catch (error) {
                console.error('Error getting CSRF token:', error);
                return null;
            }
        }

        // Register form submission
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                full_name: document.getElementById('fullname').value.trim(),
                username: document.getElementById('username').value.trim(),
                email: document.getElementById('email').value.trim(),
                password: document.getElementById('password').value,
                confirm_password: document.getElementById('password_confirm').value,
                agree_terms: document.getElementById('agreeTerms').checked
            };
            
            // Validation
            if (!formData.full_name || !formData.username || !formData.email || !formData.password || !formData.confirm_password) {
                showAlert('error', translations[currentLang].requiredFields);
                return;
            }
            
            if (formData.password !== formData.confirm_password) {
                showAlert('error', translations[currentLang].passwordMismatch);
                return;
            }
            
            if (!formData.agree_terms) {
                showAlert('error', translations[currentLang].agreeTermsRequired);
                return;
            }
            
            // Show loading state
            const registerBtn = document.getElementById('registerBtn');
            const registerBtnText = document.getElementById('registerBtnText');
            const registerSpinner = document.getElementById('registerSpinner');
            
            registerBtn.disabled = true;
            registerBtnText.style.display = 'none';
            registerSpinner.style.display = 'inline-block';
            
            // Get CSRF token
            const csrfToken = await getCSRFToken();
            if (!csrfToken) {
                showAlert('error', 'Không thể lấy token bảo mật');
                registerBtn.disabled = false;
                registerBtnText.style.display = 'inline-block';
                registerSpinner.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert('success', translations[currentLang].registerSuccess);
                    
                    // Reset form
                    document.getElementById('registerForm').reset();
                    
                    // Redirect to login after 3 seconds
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 3000);
                } else {
                    showAlert('error', data.message || translations[currentLang].registerError);
                }
            } catch (error) {
                console.error('Registration error:', error);
                showAlert('error', translations[currentLang].networkError);
            } finally {
                // Reset button state
                registerBtn.disabled = false;
                registerBtnText.style.display = 'inline-block';
                registerSpinner.style.display = 'none';
            }
        });
        
        // Social register functions
        function registerWithGoogle() {
            console.log('Google register clicked');
            showAlert('error', 'Tính năng đăng ký Google đang được phát triển');
        }
        
        function registerWithFacebook() {
            console.log('Facebook register clicked');
            showAlert('error', 'Tính năng đăng ký Facebook đang được phát triển');
        }
        
        // Auto-focus fullname field
        document.getElementById('fullname').focus();
    </script>
</body>
</html>